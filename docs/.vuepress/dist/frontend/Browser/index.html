<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>事件机制 | W-Qing&#39;s Notes</title>
    <meta name="description" content="W-Qing 码字的地方 👨🏻‍💻">
    <link rel="icon" href="/img/favorite.ico">
    
    <link rel="preload" href="/assets/css/0.styles.a046c278.css" as="style"><link rel="preload" href="/assets/js/app.525f7ea4.js" as="script"><link rel="preload" href="/assets/js/9.f340d369.js" as="script"><link rel="preload" href="/assets/js/1.d28b38a9.js" as="script"><link rel="preload" href="/assets/js/13.1bb6764c.js" as="script"><link rel="prefetch" href="/assets/js/10.91370533.js"><link rel="prefetch" href="/assets/js/11.b8104e52.js"><link rel="prefetch" href="/assets/js/12.a5d9cb56.js"><link rel="prefetch" href="/assets/js/14.dcd19725.js"><link rel="prefetch" href="/assets/js/15.5a5d9c51.js"><link rel="prefetch" href="/assets/js/16.55d2e77c.js"><link rel="prefetch" href="/assets/js/17.f7c1e909.js"><link rel="prefetch" href="/assets/js/18.37f66fcc.js"><link rel="prefetch" href="/assets/js/3.76edbf65.js"><link rel="prefetch" href="/assets/js/4.8c7a505a.js"><link rel="prefetch" href="/assets/js/5.c2cf6e26.js"><link rel="prefetch" href="/assets/js/6.2d4fc349.js"><link rel="prefetch" href="/assets/js/7.19e90f9a.js"><link rel="prefetch" href="/assets/js/8.4d905b9b.js">
    <link rel="stylesheet" href="/assets/css/0.styles.a046c278.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">W-Qing's Notes</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端" class="dropdown-title"><span class="title">前端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>基础</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/frontend/HTML/" class="nav-link">HTML</a></li><li class="dropdown-subitem"><a href="/frontend/CSS/" class="nav-link">CSS</a></li><li class="dropdown-subitem"><a href="/frontend/JavaScript/" class="nav-link">JavaScript</a></li><li class="dropdown-subitem"><a href="/frontend/Browser/" class="nav-link router-link-exact-active router-link-active">浏览器</a></li></ul></li><li class="dropdown-item"><h4>框架</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/frontend/Vue/" class="nav-link">Vue</a></li><li class="dropdown-subitem"><a href="/frontend/React/" class="nav-link">React</a></li></ul></li></ul></div></div><div class="nav-item"><a href="/about/" class="nav-link">About</a></div><div class="nav-item"><a href="https://github.com/W-Qing" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端" class="dropdown-title"><span class="title">前端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>基础</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/frontend/HTML/" class="nav-link">HTML</a></li><li class="dropdown-subitem"><a href="/frontend/CSS/" class="nav-link">CSS</a></li><li class="dropdown-subitem"><a href="/frontend/JavaScript/" class="nav-link">JavaScript</a></li><li class="dropdown-subitem"><a href="/frontend/Browser/" class="nav-link router-link-exact-active router-link-active">浏览器</a></li></ul></li><li class="dropdown-item"><h4>框架</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/frontend/Vue/" class="nav-link">Vue</a></li><li class="dropdown-subitem"><a href="/frontend/React/" class="nav-link">React</a></li></ul></li></ul></div></div><div class="nav-item"><a href="/about/" class="nav-link">About</a></div><div class="nav-item"><a href="https://github.com/W-Qing" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>基础</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/frontend/HTML/" class="sidebar-link">HTML</a></li><li><a href="/frontend/CSS/" class="sidebar-link">CSS</a></li><li><a href="/frontend/JavaScript/" class="sidebar-link">JS</a></li><li><a href="/frontend/Browser/" class="active sidebar-link">事件机制</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/frontend/Browser/#事件机制" class="sidebar-link">事件机制</a></li><li class="sidebar-sub-header"><a href="/frontend/Browser/#存储" class="sidebar-link">存储</a></li><li class="sidebar-sub-header"><a href="/frontend/Browser/#ajax" class="sidebar-link">Ajax</a></li><li class="sidebar-sub-header"><a href="/frontend/Browser/#跨域" class="sidebar-link">跨域</a></li><li class="sidebar-sub-header"><a href="/frontend/Browser/#渲染机制" class="sidebar-link">渲染机制</a></li></ul></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>框架</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="事件机制"><a href="#事件机制" class="header-anchor">#</a> 事件机制</h2> <h3 id="事件触发三阶段"><a href="#事件触发三阶段" class="header-anchor">#</a> 事件触发三阶段</h3> <ol><li><strong>捕获：</strong><code>window</code> 往事件触发处传播，遇到注册的捕获事件会触发。</li> <li>传播到事件触发处时触发注册的事件。</li> <li>**冒泡：**从事件触发处往 <code>window</code> 传播，遇到注册的冒泡事件会触发。</li></ol> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 以下会先打印冒泡然后是捕获</span>
node<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span>
  <span class="token string">'click'</span><span class="token punctuation">,</span>
  <span class="token parameter">event</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'冒泡'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token boolean">false</span>
<span class="token punctuation">)</span>
node<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span>
  <span class="token string">'click'</span><span class="token punctuation">,</span>
  <span class="token parameter">event</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'捕获 '</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token boolean">true</span>
<span class="token punctuation">)</span>
</code></pre></div><ul><li>阻止事件冒泡 e.stopPropagation()</li></ul> <h3 id="注册事件"><a href="#注册事件" class="header-anchor">#</a> 注册事件</h3> <p>通常我们使用 <code>addEventListener</code> 注册事件，该函数的第三个参数可以是布尔值，也可以是对象。对于布尔值 <code>useCapture</code> 参数来说，该参数默认值为 <code>false</code> 。<code>useCapture</code> 决定了注册的事件是捕获事件还是冒泡事件。对于对象参数来说，可以使用以下几个属性</p> <ul><li><code>capture</code>，布尔值，和 <code>useCapture</code> 作用一样</li> <li><code>once</code>，布尔值，值为 <code>true</code> 表示该回调只会调用一次，调用后会移除监听</li> <li><code>passive</code>，布尔值，表示永远不会调用 <code>preventDefault</code></li></ul> <p>一般来说，我们只希望事件只触发在目标上，这时候可以使用 <code>stopPropagation</code> 来阻止事件的进一步传播。通常我们认为 <code>stopPropagation</code> 是用来阻止事件冒泡的，其实该函数也可以阻止捕获事件。<code>stopImmediatePropagation</code> 同样也能实现阻止事件，但是还能阻止该事件目标执行别的注册事件。</p> <div class="language-js extra-class"><pre class="language-js"><code>node<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span>
  <span class="token string">'click'</span><span class="token punctuation">,</span>
  <span class="token parameter">event</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    event<span class="token punctuation">.</span><span class="token function">stopImmediatePropagation</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'冒泡'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token boolean">false</span>
<span class="token punctuation">)</span>
<span class="token comment">// 点击 node 只会执行上面的函数，该函数不会执行</span>
node<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span>
  <span class="token string">'click'</span><span class="token punctuation">,</span>
  <span class="token parameter">event</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'捕获 '</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token boolean">true</span>
<span class="token punctuation">)</span>
</code></pre></div><h3 id="事件代理"><a href="#事件代理" class="header-anchor">#</a> 事件代理</h3> <p>如果一个节点中的子节点是动态生成的，那么子节点需要注册事件的话应该注册在父节点上，即事件代理。</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>list<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>item1<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>项目 1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>item2<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>项目 2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>item3<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>项目 3<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
  <span class="token comment">&lt;!-- 随时会新增更多的 li 标签 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  <span class="token keyword">let</span> ul <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'#list'</span><span class="token punctuation">)</span>
  ul<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span> <span class="token parameter">event</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>target<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>事件代理的方式相对于直接给目标注册事件来说，有以下优点</p> <ul><li>节省内存</li> <li>不需要给子节点注销事件</li></ul> <h2 id="存储"><a href="#存储" class="header-anchor">#</a> 存储</h2> <h3 id="前端存储有几种方式？区别是什么？🌟"><a href="#前端存储有几种方式？区别是什么？🌟" class="header-anchor">#</a> 前端存储有几种方式？区别是什么？🌟</h3> <p><strong>一共 5 种方式：</strong> cookies、localstorage、sessionstorage、Web SQL（已废弃）、IndexedDB</p> <ol><li><p><strong>Cookies：</strong></p> <p>本身是用于客户端和服务端通信的，但是它有本地存储的功能，于是就被 ”借用“。是在 HTML5 标准前本地储存的主要方式。</p> <p>优点是是兼容性好，但缺点很多：数据存储量太小，只有 4kb。所有 http 请求头自动携带 cookie ，浪费流量，影响获取资源的效率。 每个 domain 限制 20 个 cookie，API 使用起来麻烦需要自行封装。</p></li> <li><p><strong>localStorage：</strong></p> <p>HTML5 加入的以键值对 (Key-Value) 为标准的方式，专门为存储而设计。优点是操作方便。永久性储存（除非手动删除），并可用于所有同源（相同的域名、协议和端口）窗口（或标签页），大小为 5M，兼容 IE8+</p> <blockquote><p>IOS safari 隐身模式下，localStorage.getItem 会报错，建议统一使用 try-catch 封装。</p></blockquote></li> <li><p><strong>sessionStorage：</strong></p> <p>与 localStorage 基本类似，API 简单易用。区别是 sessionStorage 在当页面关闭后会被清理，而且与 cookie、localStorage 不同，他不能在所有同源窗口中共享，是会话级别的储存方式</p> <blockquote><p>这里需要注意的是，页面及标签页仅指顶级窗口，如果一个标签页包含多个 iframe 标签且他们属于同源页面，那么他们之间是可以共享 sessionStorage 的。</p></blockquote></li> <li><p><strong>Web SQL：</strong></p> <p>2010 年被 W3C 废弃的本地数据库数据存储方案，但是主流浏览器（火狐除外）都已经有了相关的实现，web sql 类似于 SQLite，是真正意义上的关系型数据库，用 sql 进行操作，当我们用 JavaScript 时要进行转换，较为繁琐。</p></li> <li><p><strong>IndexedDB：</strong></p> <p>是被正式纳入 HTML5 标准的数据库储存方案，它是 NoSQL 数据库，用键值对进行储存，可以进行快速读取操作，非常适合 web 场景，同时用 JavaScript 进行操作会非常方便。</p></li></ol> <p>速览表：</p> <table><thead><tr><th style="text-align:center;">特性</th> <th style="text-align:center;">cookie</th> <th style="text-align:center;">localStorage</th> <th style="text-align:center;">sessionStorage</th> <th style="text-align:center;">indexDB</th></tr></thead> <tbody><tr><td style="text-align:center;">数据生命周期</td> <td style="text-align:center;">一般由服务器生成，可以设置过期时间</td> <td style="text-align:center;">除非被清理，否则一直存在</td> <td style="text-align:center;">页面关闭就清理</td> <td style="text-align:center;">除非被清理，否则一直存在</td></tr> <tr><td style="text-align:center;">数据存储大小</td> <td style="text-align:center;">4K</td> <td style="text-align:center;">5M</td> <td style="text-align:center;">5M</td> <td style="text-align:center;">无限</td></tr> <tr><td style="text-align:center;">与服务端通信</td> <td style="text-align:center;">每次都会携带在 header 中，对于请求性能影响</td> <td style="text-align:center;">不参与</td> <td style="text-align:center;">不参与</td> <td style="text-align:center;">不参与</td></tr></tbody></table> <p>**建议：**从上表可以看出，<code>cookie</code> 已经不建议用于存储。如果没有大量数据存储需求的话，可以使用 <code>localStorage</code> 和 <code>sessionStorage</code> 。对于不怎么改变的数据尽量使用 <code>localStorage</code> 存储，否则可以用 <code>sessionStorage</code> 存储。</p> <p>对于 <code>cookie</code>，我们还需要注意安全性。</p> <table><thead><tr><th style="text-align:center;">属性</th> <th style="text-align:center;">作用</th></tr></thead> <tbody><tr><td style="text-align:center;">value</td> <td style="text-align:center;">如果用于保存用户登录态，应该将该值加密，不能使用明文的用户标识</td></tr> <tr><td style="text-align:center;">http-only</td> <td style="text-align:center;">不能通过 JS 访问 Cookie，减少 XSS 攻击</td></tr> <tr><td style="text-align:center;">secure</td> <td style="text-align:center;">只能在协议为 HTTPS 的请求中携带</td></tr> <tr><td style="text-align:center;">same-site</td> <td style="text-align:center;">规定浏览器不能在跨域请求中携带 Cookie，减少 CSRF 攻击</td></tr></tbody></table> <blockquote><p>推荐阅读：<a href="https://segmentfault.com/a/1190000005927232" target="_blank" rel="noopener noreferrer">聊一聊前端存储那些事<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></blockquote> <h3 id="service-worker"><a href="#service-worker" class="header-anchor">#</a> Service Worker</h3> <p><strong>Waiting for the update</strong></p> <h2 id="ajax"><a href="#ajax" class="header-anchor">#</a> Ajax</h2> <p><a href="https://juejin.im/post/58c883ecb123db005311861a" target="_blank" rel="noopener noreferrer">Ajax 知识体系大梳理<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <h2 id="跨域"><a href="#跨域" class="header-anchor">#</a> 跨域</h2> <p>因为浏览器出于安全考虑，有同源策略，不允许跨域访问其他域的接口。协议、域名或者端口有一个不同就算跨域，而且所有的跨域请求都必须经过信息提供方允许，否则 Ajax 请求就会失败。</p> <p>但是 HTML 有三个标签允许跨域加载资源：</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>xxx<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>xxx<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>xxx<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>因此这三个标签有它们的使用场景：</p> <blockquote><p>img 用于打点统计，统计网站可能是其他域</p> <p>link、script 可以使用 CDN，CDN 加载的也是其他域资源</p> <p>script 可以用于 JSONP</p></blockquote> <p>我们可以通过以下几种常用方法解决跨域的问题</p> <h3 id="jsonp"><a href="#jsonp" class="header-anchor">#</a> JSONP</h3> <p>JSONP 的原理很简单，就是利用 <code>&lt;script&gt;</code> 标签没有跨域限制的漏洞。通过 <code>&lt;script&gt;</code> 标签指向一个需要访问的地址并提供一个回调函数来接收数据。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token operator">&lt;</span>script src<span class="token operator">=</span><span class="token string">&quot;http://domain/api?param1=a&amp;param2=b&amp;callback=jsonp&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>script<span class="token operator">&gt;</span>
    <span class="token keyword">function</span> <span class="token function">jsonp</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    	console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>

<span class="token comment">// 或者是下面这种方式</span>
<span class="token operator">&lt;</span>script<span class="token operator">&gt;</span>
window<span class="token punctuation">.</span><span class="token function-variable function">callback</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token operator">&lt;</span>script<span class="token operator">/</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>script src <span class="token operator">=</span> <span class="token string">&quot;http://demo.com/api.js&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span>script<span class="token operator">/</span><span class="token operator">&gt;</span>
<span class="token comment">// 该接口将返回 callback({x:10, y:20}) 执行 callback 方法</span>
</code></pre></div><ol><li>提前定义好跨域请求的接口要返回的函数</li> <li>通过 script 跨域加载 js 文件，绕过浏览器的同源策略</li> <li>加载请求的 js 文件，同时执行 callback 函数 得到请求的数据</li></ol> <p>JSONP 使用简单且兼容性不错，但是它只限于 <code>get</code> 请求。</p> <p>在开发中可能会遇到多个 JSONP 请求的回调函数名是相同的，这时候就需要自己封装一个 JSONP，以下是简单实现</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">jsonp</span><span class="token punctuation">(</span><span class="token parameter">url<span class="token punctuation">,</span> jsonpCallback<span class="token punctuation">,</span> success</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> script <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'script'</span><span class="token punctuation">)</span>
  script<span class="token punctuation">.</span>src <span class="token operator">=</span> url
  script<span class="token punctuation">.</span>async <span class="token operator">=</span> <span class="token boolean">true</span>
  script<span class="token punctuation">.</span>type <span class="token operator">=</span> <span class="token string">'text/javascript'</span>
  window<span class="token punctuation">[</span>jsonpCallback<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    success <span class="token operator">&amp;&amp;</span> <span class="token function">success</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>script<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token function">jsonp</span><span class="token punctuation">(</span><span class="token string">'http://xxx'</span><span class="token punctuation">,</span> <span class="token string">'callback'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="cors"><a href="#cors" class="header-anchor">#</a> CORS</h3> <p>CORS 需要浏览器和后端同时支持。IE 8 和 9 需要通过 <code>XDomainRequest</code> 来实现。</p> <p>浏览器会自动进行 CORS 通信，实现 CORS 通信的关键是后端。只要后端实现了 CORS，就实现了跨域。</p> <p>服务端通过设置 http header 的 <code>Access-Control-Allow-Origin</code> 属性就可以开启 CORS。 该属性表示哪些域名可以访问资源，如果设置通配符则表示所有网站都可以访问资源。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 不同的后端语言会有不同</span>
response<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">&quot;Access-Control-Allow-Origin&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;http://test.com&quot;</span><span class="token punctuation">)</span> <span class="token comment">// 不建议直接写 '*'</span>
</code></pre></div><h3 id="document-domain"><a href="#document-domain" class="header-anchor">#</a> document.domain</h3> <p>该方式只能用于二级域名相同的情况下，比如 <code>a.test.com</code> 和 <code>b.test.com</code> 适用于该方式。</p> <p>只需要给页面添加 <code>document.domain = 'test.com'</code> 表示二级域名都相同就可以实现跨域</p> <h3 id="postmessage"><a href="#postmessage" class="header-anchor">#</a> postMessage</h3> <p>这种方式通常用于获取嵌入页面中的第三方页面数据。一个页面发送消息，另一个页面判断来源并接收消息</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 发送消息端</span>
window<span class="token punctuation">.</span>parent<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token string">'message'</span><span class="token punctuation">,</span> <span class="token string">'http://test.com'</span><span class="token punctuation">)</span>
<span class="token comment">// 接收消息端</span>
<span class="token keyword">var</span> mc <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MessageChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
mc<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'message'</span><span class="token punctuation">,</span> <span class="token parameter">event</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> origin <span class="token operator">=</span> event<span class="token punctuation">.</span>origin <span class="token operator">||</span> event<span class="token punctuation">.</span>originalEvent<span class="token punctuation">.</span>origin
  <span class="token keyword">if</span> <span class="token punctuation">(</span>origin <span class="token operator">===</span> <span class="token string">'http://test.com'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'验证通过'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="渲染机制"><a href="#渲染机制" class="header-anchor">#</a> 渲染机制</h2> <h3 id="加载资源的形式"><a href="#加载资源的形式" class="header-anchor">#</a> 加载资源的形式</h3> <ul><li>输入 url （或跳转页面） 加载 html</li> <li>加载 html 中的静态资源 <code>&lt;img&gt;</code> <code>&lt;script&gt;</code> <code>&lt;video&gt;</code>  css 等</li></ul> <h3 id="加载一个资源的过程"><a href="#加载一个资源的过程" class="header-anchor">#</a> 加载一个资源的过程</h3> <ul><li>浏览器根据 DNS 服务器得到域名的 IP 地址</li> <li>向这个 IP 的服务器发送 http 请求</li> <li>服务器收到请求，处理并返回 http 请求</li> <li>浏览器得到返回内容</li></ul> <h3 id="浏览器渲染页面的过程"><a href="#浏览器渲染页面的过程" class="header-anchor">#</a> 浏览器渲染页面的过程</h3> <ul><li>根据 HTML 结构生成 DOM Tree</li> <li>根据 CSS 生成 CSSOM</li> <li>将 DOM 和 CSSOM 整合形成 RenderTree</li> <li>浏览器根据 RenderTree 开始渲染和展示</li> <li>遇到<code>&lt;script&gt;</code> 时，会执行并阻塞渲染，因为 JS 有可能改变 DOM 树结构</li> <li>而 img、 video 则是异步加载，不会阻塞渲染</li></ul> <h3 id="load-和-domcontentloaded-区别"><a href="#load-和-domcontentloaded-区别" class="header-anchor">#</a> Load 和 DOMContentLoaded 区别</h3> <p>window.onload</p> <p>Load 事件触发代表页面中的 DOM，CSS，JS，图片已经全部加载完毕。</p> <p>DOMContentLoaded 事件触发代表初始的 HTML 被完全加载和解析，不需要等待 CSS，JS，图片加载。</p> <div class="language-js extra-class"><pre class="language-js"><code>window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'load'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 页面的全部资源加载完才会执行，包括图片、视频等</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

document<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'DOMContentLoaded'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// DOM 渲染完即可执行，此时图片、视频可能还没有加载完</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/frontend/JavaScript/" class="prev">JS</a></span> <span class="next"><a href="/frontend/Vue/">NextTick 原理分析</a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.525f7ea4.js" defer></script><script src="/assets/js/9.f340d369.js" defer></script><script src="/assets/js/1.d28b38a9.js" defer></script><script src="/assets/js/13.1bb6764c.js" defer></script>
  </body>
</html>
