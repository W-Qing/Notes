# ç›¸å…³æ¦‚å¿µ

https://juejin.cn/post/6844903588553048077#heading-33

## ä»€ä¹ˆæ˜¯å·¥ç¨‹åŒ–

#### å®šä¹‰

- å·¥ç¨‹åŒ–å³ç³»ç»ŸåŒ–ã€æ¨¡å—åŒ–ã€è§„èŒƒåŒ–çš„ä¸€ä¸ªè¿‡ç¨‹ã€‚
- å¦‚æœè¯´è®¡ç®—æœºç§‘å­¦è¦è§£å†³çš„æ˜¯ç³»ç»Ÿçš„æŸä¸ªå…·ä½“é—®é¢˜ï¼Œæˆ–è€…æ›´é€šä¿—ç‚¹è¯´æ˜¯é¢å‘ç¼–ç çš„ï¼Œé‚£ä¹ˆå·¥ç¨‹åŒ–è¦è§£å†³çš„æ˜¯å¦‚ä½•æé«˜æ•´ä¸ªç³»ç»Ÿç”Ÿäº§æ•ˆç‡ã€‚
- ä¸å…¶è¯´è½¯ä»¶å·¥ç¨‹æ˜¯ä¸€é—¨ç§‘å­¦ï¼Œä¸å¦‚è¯´å®ƒæ›´åå‘äºç®¡ç†å­¦å’Œæ–¹æ³•è®ºã€‚

#### è§£å†³ä»€ä¹ˆé—®é¢˜

- å·¥ç¨‹åŒ–è§£å†³çš„é—®é¢˜æ˜¯ï¼Œå¦‚ä½•æé«˜ç¼–ç ã€æµ‹è¯•ã€ç»´æŠ¤é˜¶æ®µçš„ç”Ÿäº§æ•ˆç‡ã€‚

## å·¥ç¨‹åŒ–è¦è§£å†³ä»€ä¹ˆ

**1 åˆ¶å®šå„é¡¹è§„èŒƒï¼Œè®©å·¥ä½œæœ‰ç« å¯å¾ª**

- ç›®å½•ç»“æ„ã€æ–‡ä»¶å‘½åè§„èŒƒã€ç¼–ç è§„èŒƒã€å¼€å‘æµç¨‹è§„èŒƒã€æ¥å£è§„èŒƒç­‰

**2 ä½¿ç”¨ç‰ˆæœ¬æ§åˆ¶å·¥å…·ï¼Œé«˜æ•ˆå®‰å…¨çš„ç®¡ç†æºä»£ç **

- Git åˆ†æ”¯ç®¡ç†ã€commit æè¿°è§„èŒƒã€merge requestã€code review

**3 ä½¿ç”¨åˆé€‚çš„å‰ç«¯æŠ€æœ¯å’Œæ¡†æ¶ï¼Œæé«˜ç”Ÿäº§æ•ˆç‡ï¼Œé™ä½ç»´æŠ¤éš¾åº¦**

- æ¨¡å—åŒ–çš„ä»£ç ç»„ç»‡æ–¹å¼(JSæ¨¡å—åŒ–ã€CSSæ¨¡å—åŒ–)
- ç»„ä»¶åŒ–çš„ç¼–ç¨‹æ€æƒ³ï¼Œå¤„ç†UIå±‚(Reactã€Vue)
- æ•°æ®å±‚åˆ†ç¦»(reudxã€mbox)

**4 æé«˜ä»£ç çš„å¯æµ‹è¯•æ€§ï¼Œå¼•å…¥å•å…ƒæµ‹è¯•ï¼Œæé«˜ä»£ç è´¨é‡**

**5 é€šè¿‡ä½¿ç”¨å„ç§è‡ªåŠ¨åŒ–çš„å·¥ç¨‹å·¥å…·ï¼Œæå‡æ•´ä¸ªå¼€å‘ã€éƒ¨ç½²æ•ˆç‡**

## æ¨¡å—åŒ–

**æ¨¡å—åŒ–ä¸»è¦è§£å†³çš„é—®é¢˜ï¼š**

è§£å†³ä»£ç åˆ†å‰²ã€å¢å¼ºç»´æŠ¤æ€§ã€æé«˜ä»£ç é‡ç”¨ã€ä½œç”¨åŸŸéš”ç¦»ã€æ¨¡å—ä¹‹é—´çš„ä¾èµ–ç®¡ç†ã€å‘å¸ƒçš„è‡ªåŠ¨åŒ–æ‰“åŒ…ä¸å¤„ç†ç­‰å¤šä¸ªæ–¹é¢ã€‚

### éƒ½æœ‰å“ªå‡ ç§æ–¹å¼å¯ä»¥å®ç°æ¨¡å—åŒ–ï¼Œå„æœ‰ä»€ä¹ˆç‰¹ç‚¹ï¼Ÿ

[ä½ å¯èƒ½ä¸çŸ¥é“çš„ JavaScript æ¨¡å—åŒ–é‡å²](https://juejin.cn/post/6844904056847073293#heading-0)

**ç«‹å³æ‰§è¡Œå‡½æ•°**

> åœ¨æ—©æœŸï¼Œä½¿ç”¨ç«‹å³æ‰§è¡Œå‡½æ•°å®ç°æ¨¡å—åŒ–æ˜¯å¸¸è§çš„æ‰‹æ®µï¼Œé€šè¿‡å‡½æ•°ä½œç”¨åŸŸè§£å†³äº†å‘½åå†²çªã€æ±¡æŸ“å…¨å±€ä½œç”¨åŸŸçš„é—®é¢˜

```js
(function(globalVariable){
   globalVariable.test = function() {}
   // ... å£°æ˜å„ç§å˜é‡ã€å‡½æ•°éƒ½ä¸ä¼šæ±¡æŸ“å…¨å±€ä½œç”¨åŸŸ
})(globalVariable)
```

**AMD å’Œ CMD**

> ç›®å‰è¿™ä¸¤ç§å®ç°æ–¹å¼å·²ç»è¿‡æ—¶ï¼Œåªéœ€è¦äº†è§£è¿™ä¸¤è€…æ˜¯å¦‚ä½•ä½¿ç”¨çš„å³å¯ã€‚

```js
// AMD
define(['./a', './b'], function(a, b) {
  // åŠ è½½æ¨¡å—å®Œæ¯•å¯ä»¥ä½¿ç”¨
  a.do()
  b.do()
})
// CMD
define(function(require, exports, module) {
  // åŠ è½½æ¨¡å—
  // å¯ä»¥æŠŠ require å†™åœ¨å‡½æ•°ä½“çš„ä»»æ„åœ°æ–¹å®ç°å»¶è¿ŸåŠ è½½
  var a = require('./a')
  a.doSomething()
})
```

**ES Module**

> åœ¨æœ‰ Babel çš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥ä½¿ç”¨ ES6 çš„æ¨¡å—åŒ– ES Moduleã€‚è¿™æ˜¯åŸç”Ÿå®ç°çš„æ¨¡å—åŒ–æ–¹æ¡ˆã€‚

```js
// ä¸¤ç§å¯¼å‡ºæ¨¡å—çš„ API
// file a.js
export function a() {}
export function b() {}
// file b.js
export default function() {}

// å¼•å…¥æ¨¡å—çš„ API
import {a, b} from './a.js'
import XXX from './b.js'
```

**CommonJS**

> CommonJS æœ€æ—©æ˜¯Node ç‹¬æœ‰çš„è§„èŒƒï¼Œç›®å‰ä¹Ÿä»ç„¶å¹¿æ³›ä½¿ç”¨ï¼Œæ¯”å¦‚åœ¨ `Webpack` ä¸­å°±èƒ½è§åˆ°å®ƒã€‚å½“ç„¶ï¼Œæµè§ˆå™¨ä¸­ä½¿ç”¨å°±éœ€è¦ç”¨åˆ° `Browserify` è§£æäº†ã€‚å¦å¤–ç›®å‰åœ¨ Node ä¸­çš„æ¨¡å—ç®¡ç†ä¹Ÿå·²ç»å’ŒCommonJS æœ‰ä¸€äº›åŒºåˆ«äº†ã€‚

```js
// a.js
module.exports = {
    a: 1
}
// or
exports.a = 1

// b.js
var module = require('./a.js')
module.a // -> log 1
```

åœ¨ä¸Šè¿°ä»£ç ä¸­ï¼Œ`module.exports` å’Œ `exports` å¾ˆå®¹æ˜“æ··æ·†ï¼Œè®©æˆ‘ä»¬æ¥çœ‹çœ‹å¤§è‡´å†…éƒ¨å®ç°

```js
var module = require('./a.js')
module.a
// è¿™é‡Œå…¶å®å°±æ˜¯åŒ…è£…äº†ä¸€å±‚ç«‹å³æ‰§è¡Œå‡½æ•°ï¼Œè¿™æ ·å°±ä¸ä¼šæ±¡æŸ“å…¨å±€å˜é‡äº†ï¼Œ
// é‡è¦çš„æ˜¯ module è¿™é‡Œï¼Œmodule æ˜¯ Node ç‹¬æœ‰çš„ä¸€ä¸ªå˜é‡
module.exports = {
    a: 1
}
// module åŸºæœ¬å®ç°
var module = {
  id: 'xxxx', // æˆ‘æ€»å¾—çŸ¥é“æ€ä¹ˆå»æ‰¾åˆ°å®ƒå§
  exports: {} // exports å°±æ˜¯ä¸ªç©ºå¯¹è±¡
}
// è¿™ä¸ªæ˜¯ä¸ºä»€ä¹ˆ exports å’Œ module.exports ç”¨æ³•ç›¸ä¼¼çš„åŸå› 
var exports = module.exports
var load = function (module) {
    // å¯¼å‡ºçš„ä¸œè¥¿
    var a = 1
    module.exports = a
    return module.exports
};
// å½“æˆ‘ require çš„æ—¶å€™å»æ‰¾åˆ°ç‹¬ç‰¹çš„ idï¼Œç„¶åå°†è¦ä½¿ç”¨çš„ä¸œè¥¿ç”¨ç«‹å³æ‰§è¡Œå‡½æ•°åŒ…è£…ä¸‹ï¼Œover
```

å¦å¤–è™½ç„¶ `exports` å’Œ `module.exports` ç”¨æ³•ç›¸ä¼¼ï¼Œä½†æ˜¯ä¸èƒ½å¯¹ `exports` ç›´æ¥èµ‹å€¼ï¼Œä¸ä¼šæœ‰ä»»ä½•æ•ˆæœã€‚

> å› ä¸º `var exports = module.exports` è¿™å¥ä»£ç è¡¨æ˜äº† `exports` å’Œ `module.exports`äº«æœ‰ç›¸åŒåœ°å€ï¼Œé€šè¿‡æ”¹å˜å¯¹è±¡çš„å±æ€§å€¼ä¼šå¯¹ä¸¤è€…éƒ½èµ·æ•ˆï¼Œä½†æ˜¯å¦‚æœç›´æ¥å¯¹ `exports` èµ‹å€¼å°±ä¼šå¯¼è‡´ä¸¤è€…ä¸å†æŒ‡å‘åŒä¸€ä¸ªå†…å­˜åœ°å€ï¼Œä¿®æ”¹å¹¶ä¸ä¼šå¯¹ `module.exports` èµ·æ•ˆã€‚

**å¯¹äº CommonJS å’Œ ES6 ä¸­çš„æ¨¡å—åŒ–çš„ä¸¤è€…åŒºåˆ«æ˜¯ï¼š**

- å‰è€…æ”¯æŒåŠ¨æ€å¯¼å…¥ï¼Œä¹Ÿå°±æ˜¯ `require(${path}/xx.js)`ï¼Œåè€…ç›®å‰ä¸æ”¯æŒï¼Œä½†æ˜¯å·²æœ‰ææ¡ˆã€‚ï¼ˆwebpack ä¸­å¯ç”¨ï¼‰
- å‰è€…æ˜¯åŒæ­¥å¯¼å…¥ï¼Œå› ä¸ºç”¨äºæœåŠ¡ç«¯ï¼Œæ–‡ä»¶éƒ½åœ¨æœ¬åœ°ï¼ŒåŒæ­¥å¯¼å…¥å³ä½¿å¡ä½å¯¹ä¸»çº¿ç¨‹å½±å“ä¹Ÿä¸å¤§ã€‚è€Œåè€…æ˜¯å¼‚æ­¥å¯¼å…¥ï¼Œå› ä¸ºç”¨äºæµè§ˆå™¨ï¼Œéœ€è¦ä¸‹è½½æ–‡ä»¶ï¼Œå¦‚æœä¹Ÿé‡‡ç”¨åŒæ­¥å¯¼å…¥ä¼šå¯¹æ¸²æŸ“æœ‰å¾ˆå¤§å½±å“ã€‚
- å‰è€…åœ¨å¯¼å‡ºæ—¶éƒ½æ˜¯å€¼æ‹·è´ï¼Œå°±ç®—å¯¼å‡ºçš„å€¼å˜äº†ï¼Œå¯¼å…¥çš„å€¼ä¹Ÿä¸ä¼šæ”¹å˜ï¼Œæ‰€ä»¥å¦‚æœæƒ³æ›´æ–°å€¼ï¼Œå¿…é¡»é‡æ–°å¯¼å…¥ä¸€æ¬¡ã€‚ä½†æ˜¯åè€…é‡‡ç”¨å®æ—¶ç»‘å®šçš„æ–¹å¼ï¼Œå¯¼å…¥å¯¼å‡ºçš„å€¼éƒ½æŒ‡å‘åŒä¸€ä¸ªå†…å­˜åœ°å€ï¼Œæ‰€ä»¥å¯¼å…¥å€¼ä¼šè·Ÿéšå¯¼å‡ºå€¼å˜åŒ–ã€‚
- åè€…ä¼šç¼–è¯‘æˆ `require/exports` æ‰§è¡Œã€‚

## Babel ğŸŒŸ

::: tip

[Babel](https://www.babeljs.cn/docs/) æ˜¯ä¸€ä¸ªå·¥å…·é“¾ï¼Œä¸»è¦ç”¨äºï¼ˆ**è¯­æ³•è½¬æ¢**ï¼‰å°† ECMAScript 2015+ ç‰ˆæœ¬çš„ä»£ç è½¬æ¢ä¸ºå‘åå…¼å®¹çš„ JavaScript è¯­æ³•ï¼Œä»¥ä¾¿èƒ½å¤Ÿè¿è¡Œåœ¨å½“å‰å’Œæ—§ç‰ˆæœ¬çš„æµè§ˆå™¨æˆ–å…¶ä»–ç¯å¢ƒä¸­ã€‚å¦å¤–è¿˜æœ‰é€šè¿‡ **Polyfill** æ–¹å¼åœ¨ç›®æ ‡ç¯å¢ƒä¸­æ·»åŠ ç¼ºå¤±çš„ç‰¹æ€§ (é€šè¿‡ [@babel/polyfill](https://www.babeljs.cn/docs/babel-polyfill) æ¨¡å—)ã€ä»¥åŠ**æºç è½¬æ¢** (codemods)ã€‚

:::

**Babel çš„æœ¬è´¨å°±æ˜¯ä¸€ä¸ª JavaScript ç¼–è¯‘å™¨** å®ƒçš„è½¬è¯‘è¿‡ç¨‹å³å·¥ä½œåŸç†åˆ†ä¸ºä¸‰ä¸ªé˜¶æ®µï¼š

![babelåŸç†](~@frontendImg/engineering/babel.png)

1. **Parse è§£æï¼šå°†ä»£ç è§£æç”ŸæˆæŠ½è±¡è¯­æ³•æ ‘( å³AST )** 

   è¿‡ç¨‹åŒ…æ‹¬è¯æ³•åˆ†æä¸è¯­æ³•åˆ†æï¼š

   - è¯æ³•åˆ†æï¼šå°†ä»£ç (å­—ç¬¦ä¸²)åˆ†å‰²ä¸º tokenæµï¼Œå³è¯­æ³•å•å…ƒæˆçš„æ•°ç»„
   - è¯­æ³•åˆ†æï¼šåˆ†æ token æµ(ä¸Šé¢ç”Ÿæˆçš„æ•°ç»„)å¹¶ç”Ÿæˆ AST

2. **Transform è½¬æ¢ï¼šè®¿é—® AST çš„èŠ‚ç‚¹è¿›è¡Œå˜æ¢æ“ä½œç”Ÿäº§æ–°çš„ AST**

   - å¯¹äº AST è¿›è¡Œå˜æ¢ä¸€ç³»åˆ—çš„æ“ä½œï¼Œbabel æ¥å—å¾—åˆ° AST å¹¶é€šè¿‡ babel-traverse å¯¹å…¶è¿›è¡Œéå†ï¼Œåœ¨æ­¤è¿‡ç¨‹ä¸­å¯¹ç›¸åº”èŠ‚ç‚¹è¿›è¡Œæ·»åŠ ã€æ›´æ–°åŠç§»é™¤ç­‰æ“ä½œã€‚
   - [Taro](https://github.com/NervJS/taro/blob/master/packages/taro-transformer-wx/src/index.ts#L15)å°±æ˜¯åˆ©ç”¨ babel å®Œæˆçš„å°ç¨‹åºè¯­æ³•è½¬æ¢

3. **Generate ç”Ÿæˆï¼šä»¥æ–°çš„ AST ä¸ºåŸºç¡€ç”Ÿæˆä»£ç **

   - å°†å˜æ¢åçš„ AST å†è½¬æ¢ä¸º JS ä»£ç , ä½¿ç”¨åˆ°çš„æ¨¡å—æ˜¯ babel-generatorã€‚

> å¦‚ä½•å†™ä¸€ä¸ªbabelæ’ä»¶ï¼Œå‚è€ƒ[å®˜æ–¹çš„æ’ä»¶æ•™ç¨‹](https://github.com/jamiebuilds/babel-handbook/blob/master/translations/zh-Hans/plugin-handbook.md#builders)
>
> å¦‚ä½•ä¸€æ­¥æ­¥å®ç°ä¸€ä¸ªç¼–è¯‘å™¨ï¼Œå‚è€ƒå®˜ç½‘æ¨èçš„å¼€æºé¡¹ç›® [the-super-tiny-compiler](https://github.com/jamiebuilds/the-super-tiny-compiler)

